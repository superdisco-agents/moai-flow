---
title: "에이전트 래핑 방법 분석"
version: "1.0.0"
date: "2025-11-28"
category: "아키텍처 분석"
tags: ["agents", "wrapping", "delegation", "resume-pattern"]
---

# 에이전트 래핑 방법 분석

## 1. 개요: 에이전트란?

MoAI-ADK의 **에이전트(Agent)**는 도구, 모델, 스킬을 재사용 가능한 컴포넌트로 래핑하는 특화된 자율 태스크 실행기입니다. 에이전트는 다음을 가능하게 합니다:

- **모듈식 위임(Modular delegation)** - `Task()` 호출을 통한 작업 분배
- **컨텍스트 보존(Context preservation)** - YAML frontmatter를 통한 상태 유지
- **토큰 효율성(Token efficiency)** - Resume 패턴으로 40-60% 절감
- **계층적 조정(Hierarchical coordination)** - 5개 운영 계층 간 협력

**핵심 원칙**: 하나의 에이전트, 하나의 책임. 복잡성은 모놀리식이 아닌 위임을 통해 구성합니다.

---

## 2. 5계층 계층 구조 (5-Tier Hierarchy)

### ANSI 다이어그램
```
┌─────────────────────────────────────────────────────────────┐
│ TIER 1: 오케스트레이션 (ORCHESTRATION)                       │
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│ │ Coordinator │ │ Planner     │ │ Architect   │           │
│ │  조정자     │ │  계획자     │ │  설계자     │           │
│ └─────────────┘ └─────────────┘ └─────────────┘           │
└─────────────────────────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│ TIER 2: 도메인 전문가 (DOMAIN SPECIALISTS)                   │
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│ │ Researcher  │ │ Coder       │ │ Tester      │           │
│ │  연구자     │ │  코더       │ │  테스터     │           │
│ └─────────────┘ └─────────────┘ └─────────────┘           │
└─────────────────────────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│ TIER 3: 실행 (EXECUTION)                                     │
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│ │Code-Analyzer│ │Perf-Analyzer│ │ Reviewer    │           │
│ │코드 분석기  │ │성능 분석기  │ │  리뷰어     │           │
│ └─────────────┘ └─────────────┘ └─────────────┘           │
└─────────────────────────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│ TIER 4: 통합 (INTEGRATION)                                   │
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│ │GitHub-Modes │ │ PR-Manager  │ │ API-Docs    │           │
│ │GitHub 모드  │ │ PR 관리자   │ │ API 문서화  │           │
│ └─────────────┘ └─────────────┘ └─────────────┘           │
└─────────────────────────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│ TIER 5: MCP 브릿지 (MCP BRIDGE)                              │
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│ │ Memory-Mgr  │ │Neural-Agent │ │ Swarm-Init  │           │
│ │ 메모리 관리 │ │ 뉴럴 에이전트│ │ 스웜 초기화 │           │
│ └─────────────┘ └─────────────┘ └─────────────┘           │
└─────────────────────────────────────────────────────────────┘
```

### 에이전트 인벤토리 (24개 총)

| 계층 | 에이전트 이름 | 주요 역할 | 도구 | Resume? |
|------|-------------|---------|------|---------|
| **T1** | `coordinator` | 멀티 에이전트 오케스트레이션 | Task(), TodoWrite | ✅ |
| T1 | `planner` | 전략적 계획 수립 | Memory, TodoWrite | ✅ |
| T1 | `architect` | 시스템 설계 | Glob, Grep, Read | ✅ |
| **T2** | `researcher` | 요구사항 분석 | WebSearch, Memory | ✅ |
| T2 | `coder` | 코드 구현 | Write, Edit, Bash | ✅ |
| T2 | `tester` | 테스트 생성 | Write, Bash | ✅ |
| T2 | `reviewer` | 코드 리뷰 | Read, Grep | ✅ |
| **T3** | `code-analyzer` | 정적 분석 | Grep, Read | ✅ |
| T3 | `perf-analyzer` | 성능 프로파일링 | Bash, Memory | ✅ |
| T3 | `api-docs` | API 문서화 | Read, Write | ✅ |
| T3 | `task-orchestrator` | 태스크 시퀀싱 | Task(), Memory | ✅ |
| **T4** | `github-modes` | 저장소 작업 | GitHub MCP | ❌ |
| T4 | `pr-manager` | PR 자동화 | GitHub MCP | ❌ |
| T4 | `issue-tracker` | 이슈 관리 | GitHub MCP | ❌ |
| T4 | `release-manager` | 릴리스 조정 | GitHub MCP | ❌ |
| **T5** | `memory-coordinator` | 세션 간 상태 관리 | Memory MCP | ❌ |
| T5 | `neural-agent` | 패턴 학습 | Neural MCP | ❌ |
| T5 | `swarm-init` | 토폴로지 설정 | Swarm MCP | ❌ |
| T5 | `consensus-builder` | 분산 합의 | Consensus MCP | ❌ |

**Resume 지원**: 내장 에이전트 (T1-T3) = ✅ | MCP 의존 에이전트 (T4-T5) = ❌

---

## 3. YAML Frontmatter 패턴

### 기본 구조
```yaml
---
name: "coder"
role: "코드 구현 전문가"
model: "claude-sonnet-4.5"
tools:
  - Write
  - Edit
  - Read
  - Bash
skills:
  - "TypeScript/JavaScript 개발"
  - "React 컴포넌트 아키텍처"
  - "테스트 주도 개발"
constraints:
  - "파일당 500줄 이하"
  - "항상 테스트 먼저 작성"
  - "절대 경로만 사용"
---
```

### 고급 예시 (MCP 포함)
```yaml
---
name: "github-pr-manager"
role: "풀 리퀘스트 자동화"
model: "claude-sonnet-4.5"
mcp_servers:
  - github
  - claude-flow
tools:
  - mcp__github__create_pull_request
  - mcp__github__create_pull_request_review
  - Task
skills:
  - "PR 설명 자동 생성"
  - "코드 리뷰 자동화"
  - "CI/CD 통합"
resume_enabled: false  # MCP 의존, resume 불가
---
```

### 최소 예시 (Task 위임자)
```yaml
---
name: "coordinator"
role: "멀티 에이전트 오케스트레이터"
model: "claude-sonnet-4.5"
tools:
  - Task
  - TodoWrite
  - Memory
skills:
  - "병렬 태스크 스포닝"
  - "컨텍스트 전파"
resume_enabled: true
---
```

**주요 필드**:
- `tools`: 허용된 작업 화이트리스트
- `skills`: 자연어 역량 설명
- `resume_enabled`: Resume 패턴 지원 여부
- `mcp_servers`: 외부 통합 (Resume 비활성화)

---

## 4. Task() 위임 메커니즘

### 예시 1: 병렬 에이전트 스포닝
```javascript
// 코디네이터가 한 메시지에서 3명의 전문가를 스포닝
[단일 메시지 - 병렬 실행]:
  Task("연구 에이전트", `
    React 19 서버 컴포넌트 모범 사례 분석.
    결과를 메모리 키에 저장: 'research/react19-patterns'
  `, "researcher")

  Task("코더 에이전트", `
    연구 결과를 사용하여 서버 컴포넌트 구현.
    메모리 읽기: 'research/react19-patterns'
    작성 위치: /app/src/components/ServerComponent.tsx
  `, "coder")

  Task("테스터 에이전트", `
    ServerComponent용 Jest 테스트 생성.
    90% 커버리지 목표.
    작성 위치: /app/tests/ServerComponent.test.tsx
  `, "tester")
```

### 예시 2: 순차적 의존성
```javascript
// 1단계: 연구 (실행 블록)
Task("연구 에이전트", `
  GraphQL 스키마 모범 사례 조사.
  메모리에 저장: 'graphql/schema-patterns'
`, "researcher")

// 연구 완료 대기...

// 2단계: 구현 (연구 의존)
Task("코더 에이전트", `
  메모리 사용하여 GraphQL 스키마 구축: 'graphql/schema-patterns'
  TypeScript 타입 생성
  작성 위치: /app/src/schema.ts
`, "coder")
```

### 예시 3: 계층적 위임
```javascript
// 아키텍트가 도메인 전문가에게 위임
Task("백엔드 아키텍트", `
  전자상거래용 REST API 아키텍처 설계.

  하위 태스크:
  - Task("데이터베이스 에이전트", "PostgreSQL 스키마 설계", "code-analyzer")
  - Task("API 에이전트", "Express 라우트 생성", "coder")
  - Task("보안 에이전트", "JWT 인증 구현", "reviewer")

  결과 통합 및 문서화.
`, "architect")
```

**Task() 시그니처**:
```typescript
Task(
  agent_name: string,        // 사람이 읽을 수 있는 식별자
  instructions: string,      // 전체 컨텍스트 + 태스크
  agent_type: string         // 인벤토리의 에이전트 역할
)
```

---

## 5. Resume 패턴 (40-60% 토큰 절감)

### 문제: 컨텍스트 윈도우 소진
```
전통적 접근:
[에이전트가 매 호출마다 전체 코드베이스 수신]
→ 호출당 200K 토큰
→ 느린 처리
→ 높은 비용
```

### 해결책: Resume 패턴
```
Resume 접근:
[에이전트가 델타 + 상태 참조만 수신]
→ 호출당 80K 토큰
→ 40-60% 감소
→ 2-3배 빠름
```

### 구현 (내장 에이전트)

#### 1단계: 초기 호출 (전체 컨텍스트)
```javascript
Task("코드 분석기", `
  인증 모듈 분석.
  파일: /app/src/auth/*.ts (15개 파일, 2000줄)

  상태 저장:
  - 아키텍처 다이어그램
  - 의존성 그래프
  - 보안 발견사항

  메모리 키: 'analysis/auth-module-v1'
`, "code-analyzer")
```

#### 2단계: Resume 호출 (델타만)
```javascript
Task("코드 분석기", `
  RESUME FROM: 'analysis/auth-module-v1'

  델타:
  - 새 파일: /app/src/auth/mfa.ts (50줄)
  - 수정됨: /app/src/auth/login.ts (+30줄)

  분석 업데이트 후 'analysis/auth-module-v2'에 저장
`, "code-analyzer")
```

**토큰 비교**:
- 전체 컨텍스트: 200K 토큰 (15개 파일)
- Resume 델타: 80K 토큰 (2개 파일 + 상태 참조)
- **절감: 60%**

### MCP 통합 에이전트 (Resume 불가)

**MCP 에이전트가 resume할 수 없는 이유**:
```yaml
# MCP 의존 에이전트
name: "github-pr-manager"
mcp_servers:
  - github  # 외부 상태, 직렬화 불가
resume_enabled: false
```

MCP 서버는 메모리 스냅샷에 캡처할 수 없는 자체 상태를 유지합니다. MCP 에이전트는 다음 용도로 사용:
- 외부 API 상호작용 (GitHub, 데이터베이스)
- 실시간 이벤트 스트림
- 상태 유지 연결

내장 에이전트는 다음 용도로 사용:
- 파일 작업
- 코드 분석
- 태스크 오케스트레이션

---

## 6. 모범 사례

### ✅ 권장사항

1. **단일 메시지로 작업 일괄 처리**
   ```javascript
   [한 메시지]:
     Task("agent1", "...", "coder")
     Task("agent2", "...", "tester")
     TodoWrite({todos: [...]})  // 5-10개 todos
   ```

2. **반복 분석에 Resume 사용**
   ```javascript
   // 첫 번째 패스
   Task("analyzer", "전체 코드베이스 분석 → memory:v1", "code-analyzer")

   // 증분 업데이트
   Task("analyzer", "RESUME memory:v1 + 델타 → memory:v2", "code-analyzer")
   ```

3. **파일 계층적 구조화**
   ```
   /app
     /src       ← 소스 코드
     /tests     ← 테스트 파일
     /docs      ← 문서
     /config    ← 설정
   ```

4. **제너럴리스트가 아닌 전문가에게 위임**
   ```javascript
   // ❌ 틀림: 한 에이전트가 모든 것을 수행
   Task("coder", "조사, 코딩, 테스트, 배포", "coder")

   // ✅ 맞음: 전문가가 협업
   Task("researcher", "패턴 조사", "researcher")
   Task("coder", "조사 기반 구현", "coder")
   Task("tester", "테스트 스위트 생성", "tester")
   ```

5. **에이전트 간 상태를 Memory에 저장**
   ```javascript
   // 에이전트 A가 저장
   Task("researcher", "결과 저장 → memory:research/api-patterns", "researcher")

   // 에이전트 B가 읽음
   Task("coder", "memory:research/api-patterns 읽기 → 구현", "coder")
   ```

6. **절대 경로만 사용**
   ```javascript
   // ✅ 올바름
   Write("/app/src/components/Button.tsx", content)

   // ❌ 틀림
   Write("src/components/Button.tsx", content)  // CWD 의존
   ```

### ❌ 금지사항

1. **여러 메시지로 에이전트 스포닝 금지**
2. **루트 폴더에 작업 파일 저장 금지**
3. **MCP 의존 에이전트와 Resume 사용 금지**
4. **명확한 책임 없이 에이전트 생성 금지**
5. **파일당 500줄 초과 금지 (대신 분할)**
6. **에이전트 지침에 비밀 하드코딩 금지**

---

## 요약

**AGENTS 래핑 방법** = YAML frontmatter + Task() 위임 + Resume 패턴

**주요 메트릭**:
- 5계층에 걸친 24개 에이전트
- Resume을 통해 40-60% 토큰 감소
- 2-3배 빠른 반복 분석
- 병렬 Task() 스포닝으로 100% 동시성

**다음 단계**:
1. `/agents` 디렉토리에서 에이전트 인벤토리 검토
2. YAML frontmatter 예시 학습
3. Task() 위임 패턴 연습
4. 대규모 코드베이스에 Resume 구현

---

**참고 자료**:
- `/docs/AGENTS.md` - 전체 에이전트 문서
- `/docs/TASK-DELEGATION.md` - 고급 Task() 패턴
- `/docs/RESUME-PATTERN.md` - 메모리 관리 가이드
