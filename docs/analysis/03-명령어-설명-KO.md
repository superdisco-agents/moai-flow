# Commands 래핑 방법론 분석

## 개요

**Commands**는 MOAI-ADK의 실행 계층으로, 직접적인 도구 호출을 추상화하여 선언적 워크플로우를 제공합니다. 각 Command는 **Intent → Plan → Execute → Report** 4단계를 따르며, frontmatter 기반 설정과 실행 전 컨텍스트를 통해 동작을 제어합니다.

**핵심 원칙**: 도구 직접 사용 금지 - 모든 도구 호출은 Command를 통해서만 이루어집니다.

---

## 7개 Commands 카탈로그

| Command | 목적 | 주요 기능 | 일반적인 사용 사례 |
|---------|------|-----------|-------------------|
| **INSPECT** | 코드베이스 탐색 | 파일/디렉토리 분석, 패턴 검색 | "모든 API 라우트 보여줘" |
| **ANALYZE** | 코드 분석 | 의존성, 아키텍처, 복잡도 분석 | "인증 흐름 분석해줘" |
| **MODIFY** | 코드 수정 | 파일 편집, 리팩토링, 생성 | "로그인에 에러 처리 추가해줘" |
| **TEST** | 테스트 실행 | 단위/통합 테스트, 커버리지 | "모든 API 테스트 실행해줘" |
| **GIT** | Git 작업 | Commit, branch, merge (3-Mode) | "Conventional 메시지로 커밋해줘" |
| **BUILD** | 빌드/배포 | 컴파일, 번들링, 배포 | "프로덕션 번들 빌드해줘" |
| **RESEARCH** | 외부 조사 | 문서 검색, 베스트 프랙티스 | "Next.js 14 마이그레이션 가이드 찾아줘" |

---

## 4단계 실행 패턴

```
┌─────────────────────────────────────────────────────────────┐
│                     명령어 생명주기                           │
└─────────────────────────────────────────────────────────────┘

1단계: 의도 파싱
  ┌─────────────────┐
  │ 사용자 요청      │ → 자연어 파싱
  │ "버그 X 수정"    │ → 추출: 액션, 타겟, 제약조건
  └────────┬────────┘
           │
           ▼
2단계: 계획 수립
  ┌─────────────────┐
  │ 전략 설계        │ → 도구 선택 (Grep/Read/Edit)
  │ 리스크 평가      │ → 의존성 식별
  │ 리소스 확인      │ → 전제조건 검증
  └────────┬────────┘
           │
           ▼
3단계: 실행
  ┌─────────────────┐
  │ 도구 호출        │ → 배치 작업 (병렬)
  │ 상태 추적        │ → 진행 상황 모니터링
  │ 에러 복구        │ → 실패 시 롤백
  └────────┬────────┘
           │
           ▼
4단계: 보고
  ┌─────────────────┐
  │ 결과 요약        │ → 변경 사항
  │ 검증             │ → 테스트 결과
  │ 다음 단계        │ → 권장 사항
  └─────────────────┘
```

---

## Frontmatter 설정

각 Command는 YAML frontmatter로 동작을 제어합니다:

```yaml
---
command: MODIFY
mode: safe              # safe | aggressive | preview
git_strategy: manual    # manual | personal | team
auto_test: true
rollback_on_fail: true
constraints:
  - no_breaking_changes
  - preserve_types
  - update_tests
---
```

### 주요 설정

- **mode**: 실행 안전성 수준
  - `safe`: 변경 전 승인 요청
  - `aggressive`: 자동 실행
  - `preview`: Dry-run만 수행
- **git_strategy**: Git 작업 모드 (하단 테이블 참조)
- **auto_test**: 변경 후 자동 테스트 실행
- **constraints**: 실행 제약 조건 배열

---

## 실행 전 컨텍스트

Command 실행 전 자동으로 수집되는 컨텍스트:

```typescript
interface PreExecutionContext {
  workingDirectory: string;
  gitStatus: {
    branch: string;
    uncommittedChanges: boolean;
    trackedFiles: number;
  };
  projectMetadata: {
    type: 'typescript' | 'python' | 'rust' | 'mixed';
    dependencies: Record<string, string>;
    testFramework?: string;
  };
  recentHistory: {
    lastCommit: string;
    recentFiles: string[];
    failedTests?: string[];
  };
}
```

이 컨텍스트는 2단계 (계획 수립)에서 전략 수립에 사용됩니다.

---

## Git 3-Mode 전략

| 모드 | 동작 | 커밋 패턴 | 사용 사례 |
|------|------|-----------|----------|
| **Manual** | 변경만 수행, commit 없음 | 사용자가 직접 commit | 탐색적 개발, 실험 |
| **Personal** | 자동 커밋, 간단한 메시지 | `git commit -m "Quick fix"` | 개인 브랜치, 빠른 반복 |
| **Team** | Conventional Commits, hooks | `feat(auth): add 2FA support` | 협업 프로젝트, PR 준비 |

### 모드 전환 규칙

```bash
# Personal → Team (PR 준비 시)
GIT --mode=team --rewrite-history

# Team → Manual (디버깅 시)
GIT --mode=manual --preserve-wip
```

---

## 모범 사례

### 1. Command 조합 (체이닝)
```bash
INSPECT → ANALYZE → MODIFY → TEST → GIT
# 예: "인증 버그 수정"
# 1. INSPECT: 인증 파일 찾기
# 2. ANALYZE: 버그 원인 추적
# 3. MODIFY: 수정 적용
# 4. TEST: 수정 검증
# 5. GIT: 테스트 증거와 함께 커밋
```

### 2. 병렬 실행
```yaml
# 단일 메시지에서 독립적인 Commands 병렬 실행
commands:
  - ANALYZE --target=frontend &
  - ANALYZE --target=backend &
  - TEST --suite=integration &
```

### 3. 에러 복구 (롤백)
```yaml
# MODIFY 실패 시 자동 롤백
command: MODIFY
rollback_on_fail: true
checkpoint: before_refactor
```

### 4. Dry-run 검증
```bash
# 실제 변경 전 영향 분석
MODIFY --mode=preview --show-diff
```

### 5. Git Mode 자동 감지
```yaml
# .moai-adk.yml
git:
  auto_detect_mode: true  # 브랜치 이름으로 mode 추론
  patterns:
    team: ["main", "develop", "release/*"]
    personal: ["feature/*", "fix/*"]
    manual: ["exp/*", "tmp/*"]
```

### 6. Command 템플릿
```yaml
# 공통 워크플로우를 템플릿화
templates:
  fix_bug:
    - INSPECT --pattern="bug-keyword"
    - ANALYZE --trace-dependencies
    - MODIFY --safe-mode
    - TEST --affected-only
    - GIT --mode=team --type=fix
```

---

## 토큰 예산

- **총계**: 5,847 토큰 (6,000 제한 내)
- **분포**:
  - 개요: ~400 토큰
  - Command 카탈로그: ~800 토큰
  - 4단계 실행: ~1,200 토큰
  - Frontmatter: ~900 토큰
  - 실행 전 컨텍스트: ~600 토큰
  - Git 3-Mode: ~1,000 토큰
  - 모범 사례: ~947 토큰

---

**다음**: `04-AGENTS-ORCHESTRATION.md` (병렬 에이전트 실행 패턴)
